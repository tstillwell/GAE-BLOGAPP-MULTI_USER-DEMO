{% extends "base.html" %}

{% block content %}
  {{post.render() | safe}}
  <br>
  <h4>Comments</h4>
  {{error}}
  <hr>
  {% if new_comment %}
    {{new_comment.render() | safe}}
    <script> document.write('<button class="edit_button" onclick="show_edit({{new_comment.key.id()}})">Edit Comment</button>');</script>
    <br>
  {% endif %}

  {% for c in comment_roll %}
    {{ c.render() | safe }}
    {% if c.posting_user == user %}
    <noscript>
      <form name ="edit-comment" method ="get" action="/edit/c/{{c.key.id()}}">
        <input type="submit" value="edit comment">
      </form>
    </noscript>
      <script> document.write('<button class="edit_button" onclick="show_edit({{c.key.id()}})">Edit Comment</button>');</script>
    <script>
      function show_edit(comment_id){
        var comment_classname = 'comment-' + comment_id;
        var old_comment = $('.comment-' + comment_id).html();
        $("." + comment_classname).replaceWith(
            '<div class="comment comment-' + comment_id + '">' + old_comment +
            '<div class="edit_area"><textarea id="new_comment_field_' + comment_id + '">' +
            '</textarea><br>' + '<button onclick="edit_comment(' + comment_id + ')">' +
            'Update Comment' + '</button><button onclick="cancel_edit(' + comment_id +
          ')"> Cancel</button></div></div>'
        );
        $(".edit_button").hide();
        $('form[name=comment-form]').hide();
      }
      function cancel_edit(comment_id){
        $(".edit_area").remove();
        $(".edit_button").show();
        $('form[name=comment-form]').show();
      }
    </script>
    {% endif %}
    <br>
  {% endfor %}
  <script>
    function new_comment_text(comment_id){
      return document.getElementById('new_comment_field_' + comment_id).value;
    }
    function edit_comment(comment_id){
      $.ajax({
        dataType: 'json',
        url: "/commentajax/",
        type: "POST",
        data: JSON.stringify({"comment_id": comment_id,
                              "new_text": new_comment_text(comment_id)})
      })
      .done(function( data ) {
        var comment_class = 'comment-content-' + comment_id;
        var newdiv = '<div class=' + '"' + comment_class + '"' + '>';
        $('.' + comment_class).replaceWith(newdiv + data['new_text'] + '</div>');
        $(".edit_area").remove();
        $('form[name=comment-form]').show();
      });
    };
    </script>
  <form name ="comment-form" method ="post">
    <textarea name="comment_text" placeholder="Type a comment here"></textarea>
    <br>
    <input type="submit" value="Add Comment">
  </form>

{% endblock %}
